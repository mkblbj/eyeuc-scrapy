## EyeUC å¤šåˆ—è¡¨é‡‡é›† Â· å®æ–½æ¸…å•ï¼ˆNotepadï¼‰

â€” ç›®æ ‡ç«™ç‚¹ï¼š[https://bbs.eyeuc.com/down/list](https://bbs.eyeuc.com/down/list) â€”

æœ¬æ¸…å•ç”¨äºåŸºäº v2 è§„æ ¼æ–‡æ¡£ï¼ˆ`eyeuc_scrapy_multi_list_spec.md`ï¼‰è½åœ°å¼€å‘ä¸éªŒæ”¶ï¼Œé»˜è®¤åªè®¨è®ºæ–¹æ¡ˆä¸ä»»åŠ¡ï¼Œä¸åŒ…å«å®æ–½ä»£ç ã€‚âœ…

---

### å›¾ä¾‹

- â¸ï¸ å¾…å¼€å§‹  Â· â³ è¿›è¡Œä¸­  Â· âœ… å·²å®Œæˆ  Â· âŒ å·²è·³è¿‡  Â· ğŸ” å¾…å®¡é˜…  Â· âš ï¸ é£é™©å…³æ³¨

---

## é˜¶æ®µ 1ï¼ˆMVPï¼‰ï¼šå¤šåˆ—è¡¨æŠ“å– + æŒ‰ list åˆ†æ–‡ä»¶å¯¼å‡º

### 1.1 é¡¹ç›®å‡†å¤‡ä¸ä¾èµ–
- [x] åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–ï¼ˆ`scrapy>=2.10`ï¼Œå¯é€‰ï¼š`scrapy-playwright`ï¼‰âœ…
- [x] æ ¡éªŒ `cookies.json` ç™»å½•æœ‰æ•ˆæ€§ï¼ˆäººå·¥åœ¨æµè§ˆå™¨è®¿é—® `down/list/182`ï¼‰âœ…
- [x] è®¾ç½®åŸºç¡€é™é€Ÿä¸é‡è¯•ï¼ˆAutoThrottleã€RETRYï¼‰âœ…

### 1.2 Spider å¤šå…¥å£ï¼ˆå¤š listï¼‰
- [x] æ–°/æ”¹ `spiders/eyeuc_mods.py` æ”¯æŒå‚æ•°ï¼š`cookies`ã€`list_ids`ã€`list_range`ã€`use_pw` âœ…
- [x] å®ç° `expand_list_ids(list_ids, list_range)`ï¼šåˆå¹¶/å»é‡/æ’åºï¼Œç©ºå‚æ•°é»˜è®¤ `[182]` âœ…
- [x] `start_requests()`ï¼šä¸ºæ¯ä¸ª `list_id` å‘èµ·èµ·å§‹è¯·æ±‚ï¼›`meta={cookiejar:list_id, list_id:lid}` âœ…
- [x] `use_pw` ä¸ºå¼€å…³ï¼Œä¸é»˜è®¤å¯ç”¨ Playwrightï¼ˆä»…å¿…è¦æ—¶ï¼‰âœ…
- âš ï¸ æ³¨æ„ï¼šlist_range å› ç«™ç‚¹ç¼–å·ä¸è¿ç»­ï¼Œå®é™…ç”¨å¤„æœ‰é™ï¼Œå»ºè®®ä½¿ç”¨ list_ids

### 1.3 åˆ—è¡¨è§£æä¸ç¿»é¡µ
- [x] `_guess_game_name()`ï¼šä» H1/title/é¢åŒ…å±‘èšåˆæ–‡æœ¬ï¼Œç”¨ `(NBA\s*2K\s*\d{2,4})` å½’ä¸€åŒ– âœ…
- [x] `parse_list()`ï¼šæŠ½å– `/down/view/` è¯¦æƒ…é“¾æ¥ï¼Œé¡µå†… `seen` é›†åˆå»é‡ âœ…
- [x] ä»…åœ¨ç¬¬ä¸€é¡µæ‰«æ `/down/list/{lid}/(\d+)` å–æœ€å¤§é¡µ `max_page` âœ…
- [x] ç”Ÿæˆç¬¬ 2..N é¡µè¯·æ±‚ï¼ˆåŒ `cookiejar` & `list_id`ï¼‰âœ…

### 1.4 è¯¦æƒ…è§£æ
- [x] å­—æ®µï¼š`list_id`ã€`game`ã€`title`ã€`cover_image`ã€`images`ã€`intro`ã€`content_html`ã€`downloads`ã€`detail_url`ã€`list_url` âœ…
- [x] `title`ï¼š`h1/.title` ä¼˜å…ˆï¼Œå…œåº•ä¸»æ ‡é¢˜åŒº âœ…
- [x] `cover_image`ï¼šä»åˆ—è¡¨é¡µæå–ï¼ˆå»ç¼©ç•¥å›¾åç¼€ï¼‰ âœ…
- [x] `images`ï¼šæ­£æ–‡ `<img>` ç»å¯¹ URLï¼Œå»ç¼©ç•¥å›¾åç¼€è·å–å¤§å›¾ âœ…
- [x] `downloads`ï¼šæå–å…ƒæ•°æ®ï¼ˆmid/vid/fileid/filename/sizeï¼‰ï¼Œä¸è·å–ç›´é“¾ï¼ˆé¿å…æ—¶æ•ˆæ€§ï¼‰ âœ…
- [x] æ‰€æœ‰å­—æ®µç¼ºå¤±ä½¿ç”¨ç©ºå€¼ï¼ˆä¸è·³è¿‡ itemï¼‰ âœ…

#### 1.4.x ä¸‹è½½ç›´é“¾è·å–ï¼ˆä¼˜åŒ–æ–¹æ¡ˆï¼šä¸¤é˜¶æ®µåˆ†ç¦»ï¼‰âœ…
- [x] **è®¾è®¡ç†å¿µ**ï¼šçˆ¬è™«åªæŠ“å…ƒæ•°æ®ï¼Œç›´é“¾æŒ‰éœ€åŠ¨æ€ç”Ÿæˆï¼ˆé¿å…æ—¶æ•ˆæ€§é—®é¢˜ï¼‰ âœ…
- [x] **é˜¶æ®µ 1ï¼šçˆ¬è™«**ï¼ˆé»˜è®¤æ¨¡å¼ï¼Œ`direct_dl=false`ï¼‰ âœ…
  - [x] è§£æ `_data` å˜é‡å– `mid/vid/formhash` âœ…
  - [x] è¯·æ±‚ AJAXï¼š`down.php?mod=view&mid={mid}&vid={vid}&show=todownload` âœ…
  - [x] æå–å…ƒæ•°æ®ï¼š`type, mid, vid, fileid, filename, size, version` âœ…
  - [x] è¾“å‡ºæ ¼å¼ï¼š`downloads: [{type: 'internal', mid, vid, fileid, filename, size, version}]` âœ…
  - [x] ç±»å‹åˆ¤æ–­ï¼šæœ‰æ–‡ä»¶ â†’ `internal`ï¼›æ— æ–‡ä»¶ â†’ `redirect`ï¼›å¤–é“¾ â†’ `external` âœ…

- [x] **é˜¶æ®µ 2ï¼šåŠ¨æ€è·å–è„šæœ¬**ï¼ˆ`fetch_direct_links.py`ï¼‰ âœ…
  - [x] ç”¨æ³•ï¼š`--mid 31047` æˆ– `--json output.json` æˆ– `--mids 31047,31439` âœ…
  - [x] ç”¨æˆ·æä¾›è‡ªå·±çš„ `cookies.json`ï¼ˆæŒ‰éœ€è·å–ï¼Œåˆ†å¸ƒå¼ä¸‹è½½ï¼‰ âœ…
  - [x] å®æ—¶ç”Ÿæˆç›´é“¾ï¼šè¯·æ±‚ `down.php?mod=buy&mid={mid}&vid={vid}&fileid={fileid}&hash={formhash}` âœ…
  - [x] æ•è· 302 é‡å®šå‘ï¼Œæå– `resource-file.eyeassets.com` ç›´é“¾ âœ…
  - [x] è§£æè¿‡æœŸæ—¶é—´ï¼šä» `auth_key` æ—¶é—´æˆ³æå– `expires_at` âœ…
  - [x] è¾“å‡ºæ ¼å¼ï¼šJSONï¼ŒåŒ…å« `{mid: {downloads: [{fileid, filename, size, direct_url, expires_at}]}}` âœ…

- [x] **éªŒæ”¶** âœ…
  - [x] çˆ¬è™«è¾“å‡ºåŒ…å«å®Œæ•´å…ƒæ•°æ®ï¼ˆmid/vid/fileid/filename/sizeï¼‰ âœ…
  - [x] åŠ¨æ€è„šæœ¬æˆåŠŸç”Ÿæˆç›´é“¾ï¼ˆæµ‹è¯• mid=31047ï¼‰ âœ…
  - [x] æ‰¹é‡å¤„ç†ï¼šä» JSON è¯»å–å¤šä¸ª mid å¹¶è·å–ç›´é“¾ âœ…

### 1.5 å¯¼å‡ºï¼šæŒ‰ list åˆ†æ–‡ä»¶ + åˆå¹¶æ–‡ä»¶
- [x] å®ç° `PerListJsonPipeline`ï¼ˆJSONL é»˜è®¤ï¼›å¯åˆ‡æ¢ JSON æ•°ç»„ï¼‰ âœ…
- [x] æ–‡ä»¶å‘½åï¼š`eyeuc_list{list_id}_{game?}_{YYYYmmdd_HHMMSS}.jsonl` âœ…
- [x] `settings.py`ï¼š âœ…
  - [x] `ITEM_PIPELINES = {"eyeuc.pipelines.PerListJsonPipeline": 300}` âœ…
  - [x] `PER_LIST_OUTPUT_DIR = "per_list_output"`ï¼Œ`PER_LIST_AS_JSONL = True` âœ…
- [x] FEEDS `-O` åˆå¹¶å¯¼å‡ºä¿ç•™ï¼ˆå¯é€‰ï¼‰ âœ…

### 1.6 è¿è¡Œä¸éªŒæ”¶
- [x] å• list éªŒè¯ï¼š`scrapy crawl eyeuc_mods -a cookies=cookies.json -a list_ids=172` âœ…
- [x] å¤š list éªŒè¯ï¼š`scrapy crawl eyeuc_mods -a list_ids=172,93 -O test_all_172_93.json` âœ…
- [ ] åŒºé—´éªŒè¯ï¼š`scrapy crawl eyeuc_mods -a list_range=180-185` (è·³è¿‡ï¼Œç¼–å·ä¸è¿ç»­)
- [ ] æ–­ç‚¹ç»­è·‘ï¼š`-s JOBDIR=.job/eyeuc_multi` (Stage 2)

éªŒæ”¶æ ‡å‡†ï¼ˆMVPï¼‰ï¼š
- [x] cookies æœ‰æ•ˆï¼šåˆ—è¡¨é¡µæ— "ç™»å½•/æƒé™ä¸è¶³"æç¤º âœ…
- [x] ç¿»é¡µå®Œæ•´ï¼šæœ«é¡µä¸ä¸¢ï¼›`max_page` ä¸ UI ä¸€è‡´ âœ…
- [x] è¯¦æƒ…å»é‡ï¼šæŒ‰ `detail_url` è®¡æ•°æ— é‡å¤ âœ…
- [x] æ¯ä¸ª `list_id` äº§å‡º 1 ä»½ JSONLï¼Œå­—æ®µé½å…¨ âœ…
- [x] åˆå¹¶æ–‡ä»¶å­˜åœ¨ï¼Œè®°å½•æ•° â‰ˆ å„ JSONL æ€»å’Œ âœ…

---

## é˜¶æ®µ 2ï¼šç¨³å¥æ€§ä¸å¯ç»´æŠ¤æ€§

### 2.1 å¹¶å‘ä¸é£æ§
- [x] AutoThrottleï¼šåˆå§‹/æœ€å°å»¶è¿Ÿ 0.3sï¼Œæœ€å¤§ 6s âœ…
- [x] å¹¶å‘ï¼š`CONCURRENT_REQUESTS=12`ï¼ŒåŸŸå†… `6` âœ…
- [x] éšæœºå»¶è¿Ÿä¸­é—´ä»¶ï¼ˆé¿å…èŠ‚å¾‹åŒ–ï¼Œ0.1-0.4sï¼‰âœ…

### 2.2 é€‰æ‹©å™¨ä¸å…œåº•
- [x] å…³é”®å—é‡‡ç”¨é€‰æ‹©å™¨å…œåº•æ–¹æ³• `_extract_with_fallback` âœ…
- [x] DOM æ”¹ç‰ˆç›‘æ§ï¼šå¤±è´¥æ ·æœ¬è½ç›˜ï¼ˆ`ParseErrorMonitorMiddleware`ï¼‰âœ…

### 2.3 é”™è¯¯ä¸é‡è¯•
- [x] åˆ†ç±»è®°å½•ç½‘ç»œ/è§£æ/æƒé™é”™è¯¯ï¼ˆ`EnhancedRetryMiddleware`ï¼‰âœ…
- [x] å…³é”®æŒ‡æ ‡æ—¥å¿—ï¼šæŠ“å–é‡ã€å¤±è´¥ç‡ã€é‡è¯•ç‡ã€å¹³å‡å“åº”æ—¶å»¶ âœ…

### 2.4 å¯é‡å…¥ä¸æŒ‡çº¹
- [x] `JOBDIR` å¯é‡å…¥éªŒè¯ï¼ˆæµ‹è¯•é€šè¿‡ï¼‰âœ…
- [x] æŒ‡çº¹é”®ï¼š`detail_url`ï¼ˆScrapy é»˜è®¤ï¼‰âœ…

éªŒæ”¶æ ‡å‡†ï¼ˆé˜¶æ®µ 2ï¼‰ï¼š
- [x] é•¿è·‘ç¨³å®šæ— å´©æºƒï¼ŒæˆåŠŸç‡ 100% âœ…
- [x] é€‰æ‹©å™¨å…œåº•æœºåˆ¶å°±ç»ª âœ…
- [x] å…³é”®æ—¥å¿—æŒ‡æ ‡å¯ç”¨ï¼Œä¾¿äºå›å½’ âœ…

---

2. ç”Ÿäº§éƒ¨ç½²
     - å®šæ—¶ä»»åŠ¡
     - ç›‘æ§å‘Šè­¦
     - æ•°æ®å…¥åº“

## é˜¶æ®µ 3ï¼ˆå¯é€‰å¢å¼ºï¼‰ï¼šå›¾ç‰‡è½åœ°ï¼ˆImagesPipelineï¼‰

### 3.1 ç®¡é“å®ç°
- [ ] æ–°å»º `PerListImagesPipeline` ç»§æ‰¿ `ImagesPipeline`
- [ ] `get_media_requests` ä» `item['images']` è¯»å– URLï¼ˆæ— éœ€ `image_urls`ï¼‰
- [ ] `file_path` ç»„ç»‡ï¼š`IMAGES_STORE/eyeuc/list{list_id}/{game_slug}/{sha1[:2]}/{sha1}.ext`
- [ ] `item_completed` å†™å› `image_paths`ã€`cover_image_local`ï¼ˆå¯é€‰ï¼‰

### 3.2 é…ç½®ä¸å¹¶å‘
- [ ] `IMAGES_STORE = "images"`ï¼ˆæˆ– S3/OSSï¼‰
- [ ] `MEDIA_ALLOW_REDIRECTS=True`ï¼Œ`DOWNLOAD_TIMEOUT=30`
- [ ] é™ä½åŸŸå†…å¹¶å‘ï¼ˆå›¾ç‰‡ä¸‹è½½ä¸é¡µé¢æŠ“å–å…±äº«å¹¶å‘ï¼‰
- [ ] `ITEM_PIPELINES` é¡ºåºï¼šå»ºè®®å›¾ç‰‡ç®¡é“åœ¨ JSON å†™å…¥ä¹‹å‰

éªŒæ”¶æ ‡å‡†ï¼ˆé˜¶æ®µ 3ï¼‰ï¼š
- [ ] 181/182 æ ·æœ¬ `image_paths` æ•°é‡ â‰ˆ `images` æ•°é‡
- [ ] ç£ç›˜è·¯å¾„ç¬¦åˆ `list_id/game_slug` ç»„ç»‡
- [ ] JSON åŒæ—¶åŒ…å«è¿œç¨‹ URL ä¸æœ¬åœ°è·¯å¾„ï¼›å¤±è´¥ç‡ < 3%

---

## å¿«é€Ÿå‘½ä»¤ï¼ˆæ¼”ç¤ºï¼‰

```bash
# å•ä¸ª listï¼ˆä¾‹å¦‚ 182 â†’ 2K24ï¼‰
scrapy crawl eyeuc_mods -a cookies=cookies.json -a list_ids=182 -O all_182.json

# å¤šä¸ª listï¼ˆé€—å·åˆ†éš”ï¼‰
scrapy crawl eyeuc_mods -a cookies=cookies.json -a list_ids=181,182,183 -O all_181_182_183.json

# èŒƒå›´ï¼ˆåŒºé—´ï¼‰
scrapy crawl eyeuc_mods -a cookies=cookies.json -a list_range=180-185

# æ–­ç‚¹ç»­è·‘
scrapy crawl eyeuc_mods -a cookies=cookies.json -a list_ids=181,182 -s JOBDIR=.job/eyeuc_multi
```

---

## é£é™©ä¸å¯¹ç­–
- âš ï¸ Cookie è¿‡æœŸ/æ‰çº¿ï¼šæ£€æµ‹ 302/ç™»å½•æç¤º â†’ æç¤ºæ›´æ–° cookies æˆ–ä¸´æ—¶ `use_pw=true`
- âš ï¸ DOM æ”¹ç‰ˆï¼šåŒè·¯é€‰æ‹©å™¨ + HTML å¿«ç…§è½ç›˜ï¼Œå¿«é€Ÿä¿®å¤
- âš ï¸ åçˆ¬æ”¶ç´§ï¼šé™å¹¶å‘/å¢å»¶è¿Ÿ/å¯ç”¨ AutoThrottleï¼›å¿…è¦æ—¶é™åˆ° 1â€“2 rps
- âš ï¸ å¤–é“¾ä¸å¯è¾¾ï¼šä»…è®°å½•é“¾æ¥ä¸ä¸‹è½½ï¼Œé¿å…é‡è¯•é£æš´

---

## é‡Œç¨‹ç¢‘æ£€æŸ¥

### MVP å®Œæˆ
- [x] å¤šå…¥å£æŠ“å–ä¸ç¿»é¡µå®Œæ•´ âœ…
- [x] å­—æ®µé½å…¨ä¸å»é‡é€šè¿‡ âœ…
- [x] æŒ‰ list JSONL äº§å‡º + åˆå¹¶æ–‡ä»¶å¯ç”¨ âœ…

### ç¨³å¥æ€§å®Œæˆ
- [x] é™é€Ÿ/å¹¶å‘ç­–ç•¥å›ºåŒ– âœ…
- [x] é€‰æ‹©å™¨å…œåº•ä¸æ—¥å¿—æŒ‡æ ‡å°±ç»ª âœ…

### å›¾ç‰‡è½åœ°ï¼ˆå¯é€‰ï¼‰
- [ ] å›¾ç‰‡ç®¡é“å¯ç”¨å¹¶é€šè¿‡æ ·æœ¬éªŒæ”¶

---

## è§’è‰²ä¸è®¡åˆ’ï¼ˆå¯å¡«å†™ï¼‰
- Ownerï¼š
- å®¡é˜…äººï¼š
- è®¡åˆ’èµ·æ­¢ï¼š
- ç›®æ ‡ç‰ˆæœ¬ï¼š

---

## å‚è€ƒ
- EyeUC èµ„æºåˆ—è¡¨å¯¼èˆªé¡µï¼š[https://bbs.eyeuc.com/down/list](https://bbs.eyeuc.com/down/list)
- è§„æ ¼æ–‡æ¡£ï¼š`docs/eyeuc_scrapy_multi_list_spec.md`


