# 🤖 智能并行分配策略

## 设计原则

`smart_crawl.sh` 会根据总页数自动选择最优的并行任务数，平衡**速度**与**资源占用**。

---

## 自动分配表

| 总页数 | 并行任务数 | 每任务约 | 预计耗时 | 说明 |
|--------|-----------|---------|---------|------|
| ≤10 页 | 1 | 10 页 | ~4 分钟 | 小任务，单进程足够 |
| ≤30 页 | 2 | 15 页 | ~6 分钟 | 开始并行，提速 50% |
| ≤50 页 | 3 | 17 页 | ~7 分钟 | 中等任务，3 进程最优 |
| ≤75 页 | 4 | 19 页 | ~8 分钟 | 4 核 CPU 充分利用 |
| ≤100 页 | **5** ⚡ | 20 页 | ~15 分钟 | **优化点：5 进程更快** |
| ≤150 页 | 6 | 25 页 | ~20 分钟 | 大任务，6 进程平衡 |
| ≤200 页 | 8 | 25 页 | ~25 分钟 | 8 进程，充分并行 |
| >200 页 | 10 | 20-30 页 | ~30-40 分钟 | 超大任务，最大并行 |

---

## 速度提升对比

### 100 页任务对比

| 方案 | 进程数 | 每进程页数 | 耗时 | 相比顺序 |
|------|-------|-----------|------|---------|
| 顺序 | 1 | 100 | ~80 分钟 | 基准 |
| 旧策略 | 4 | 25 | ~20 分钟 | ⬇️ 75% |
| **新策略** | **5** | **20** | **~15 分钟** ⚡ | **⬇️ 81%** |
| 手动优化 | 8 | 12.5 | ~12 分钟 | ⬇️ 85% |

**新策略在便捷性和速度间取得了最佳平衡！**

---

## 为什么 100 页选 5 进程？

### 计算依据

1. **每页平均耗时**：约 48 秒（包括网络、解析、存储）
2. **100 页顺序耗时**：100 × 48s = 4800s ≈ 80 分钟

### 4 进程 vs 5 进程

| 配置 | 每进程页数 | 单进程耗时 | 总耗时（并行） | 效率 |
|------|-----------|-----------|--------------|------|
| 4 进程 | 25 | 25 × 48s = 20 分钟 | ~20 分钟 | 75% 利用率 |
| **5 进程** | **20** | **20 × 48s = 16 分钟** | **~15 分钟** ⚡ | **85% 利用率** |
| 8 进程 | 12.5 | 12.5 × 48s = 10 分钟 | ~12 分钟 | 90% 利用率（资源紧张）|

### 为什么不直接用 8 进程？

- ✅ **5 进程**：速度快 + 资源占用适中 + 更稳定
- ⚠️ **8 进程**：速度最快，但：
  - 网络带宽竞争激烈
  - 可能被服务器限流
  - 系统负载高
  - 失败率略高

**结论**：5 进程是 100 页的甜蜜点 🎯

---

## CPU 核心数建议

### 通用建议

```bash
# 查看 CPU 核心数
nproc

# 建议并行数 = min(页数/20, CPU核心数)
```

### 不同 CPU 配置

| CPU 核心数 | 推荐最大并行 | 适用页数 |
|-----------|------------|---------|
| 2 核 | 2-3 | ≤50 页 |
| 4 核 | 4-5 | ≤100 页 |
| 8 核 | 6-8 | ≤200 页 |
| 16 核 | 10+ | 任意 |

---

## 自定义并行数

如果自动策略不适合你的环境，可以手动指定：

```bash
# 语法
./smart_crawl.sh <list_id> <pages> <parallel_jobs>

# 示例
./smart_crawl.sh 182 100 3    # 强制 3 进程（低配机器）
./smart_crawl.sh 182 100 8    # 强制 8 进程（高配机器）
./smart_crawl.sh 182 100 10   # 强制 10 进程（超快）
```

---

## 网络带宽考虑

### 网络限制

| 网络速度 | 推荐最大并行 | 说明 |
|---------|------------|------|
| < 10 Mbps | 2-3 | 避免拥塞 |
| 10-50 Mbps | 4-5 | 平衡速度 |
| 50-100 Mbps | 6-8 | 充分利用 |
| > 100 Mbps | 8-10 | 无瓶颈 |

### 服务器限流

如果遇到大量 429 错误或慢响应：

```bash
# 减少并行数
./smart_crawl.sh 182 100 2

# 或增加批次休息时间（修改 batch_crawl.sh 中的 sleep 10）
```

---

## 特殊场景优化

### 场景 1：测试/调试

```bash
# 快速验证，只抓 5 页
./smart_crawl.sh 182 5
# 自动选 1 进程
```

### 场景 2：夜间定时任务

```bash
# 最大并行，充分利用夜间时段
./smart_crawl.sh 182 200 10
```

### 场景 3：共享服务器

```bash
# 低优先级，避免影响其他用户
./smart_crawl.sh 182 100 2
```

### 场景 4：极速模式（风险）

```bash
# 最激进配置
./parallel_crawl.sh 182 100 10 3
# 10 进程，每批只抓 3 页（更快失败重试）
```

---

## 性能监控

### 实时监控

```bash
# 查看 CPU 使用率
top

# 查看网络使用
iftop
nethogs

# 查看进程
ps aux | grep scrapy
```

### 日志分析

```bash
# 统计成功率
grep "批次.*完成" logs/list182_*/job*.log | wc -l

# 统计失败率
grep "批次.*失败" logs/list182_*/job*.log | wc -l

# 平均每页耗时
# （查看日志时间戳）
```

---

## 总结

### 新策略亮点

- ✅ **100 页 → 5 进程**：速度提升 25%（相比旧的 4 进程）
- ✅ **更细粒度**：9 档自动选择（旧版只有 4 档）
- ✅ **更平衡**：考虑了速度、资源、稳定性

### 推荐用法

```bash
# 默认自动（推荐）
./smart_crawl.sh 182 100

# 保守模式（低配机器）
./smart_crawl.sh 182 100 3

# 激进模式（高配机器）
./smart_crawl.sh 182 100 8
```

---

**记住：并行不是越多越好，适合才是最好！** 🎯







